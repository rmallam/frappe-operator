name: Install Frappe Operator

on:
  workflow_dispatch:
    inputs:
      namespace:
        description: 'Namespace to install the operator into'
        required: true
        default: 'frappe-operator-system'
      create_namespace:
        description: 'Create the namespace if it does not exist'
        required: true
        type: boolean
        default: true
      release_name:
        description: 'Helm release name'
        required: true
        default: 'frappe-operator'
      image_tag:
        description: 'Operator image tag to install'
        required: true
        default: 'v0.0.6'
      image_repository:
        description: 'Operator image repository'
        required: true
        default: 'ghcr.io/rmallam/frappe-operator'

jobs:
  install:
    name: Install Operator via Helm
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'

      - name: Configure Kubectl
        uses: azure/k8s-set-context@v3
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBE_CONFIG }} # Requires KUBE_CONFIG secret

      - name: Update Helm dependencies
        run: |
          cd helm/frappe-operator
          helm dependency update

      - name: "Install Frappe Operator (Stage 1: Bootstrap & CRDs)"
        run: |
          echo "Stage 1: Installing dependencies (MariaDB Operator, KEDA) and Frappe Operator..."
          echo "The MariaDB instance is disabled in this stage to allow CRDs to be established first."
          # We remove --wait here because some subcharts might take time to reach 'Ready' on OpenShift
          # The subsequent 'Wait for MariaDB CRD' step handles the actual dependency check.
          helm upgrade --install ${{ github.event.inputs.release_name }} ./helm/frappe-operator \
            --namespace ${{ github.event.inputs.namespace }} \
            ${{ github.event.inputs.create_namespace == 'true' && '--create-namespace' || '' }} \
            --set operator.image.repository=${{ github.event.inputs.image_repository }} \
            --set operator.image.tag=${{ github.event.inputs.image_tag }} \
            --set mariadb.enabled=false \
            --timeout 10m

      - name: Wait for MariaDB CRD
        run: |
          echo "Waiting for MariaDB CRDs to be established..."
          # The MariaDB Operator installs these CRDs. We wait for them before applying the Mariadb instance.
          for i in {1..30}; do
            if kubectl get crd mariadbs.k8s.mariadb.com &>/dev/null; then
              echo "✅ MariaDB CRD detected!"
              kubectl wait --for condition=established --timeout=60s crd mariadbs.k8s.mariadb.com
              exit 0
            fi
            echo "Waiting for CRD... ($i/30)"
            sleep 10
          done
          echo "❌ MariaDB CRD did not appear in time."
          kubectl get pods -A | grep mariadb || true
          exit 1

      - name: "Install Frappe Operator (Stage 2: Full Installation)"
        run: |
          echo "Stage 2: Enabling MariaDB instance and finalizing installation..."
          helm upgrade --install ${{ github.event.inputs.release_name }} ./helm/frappe-operator \
            --namespace ${{ github.event.inputs.namespace }} \
            --set operator.image.repository=${{ github.event.inputs.image_repository }} \
            --set operator.image.tag=${{ github.event.inputs.image_tag }} \
            --set mariadb.enabled=true \
            --wait \
            --timeout 15m

      - name: Verify Installation
        run: |
          echo "Checking deployment status..."
          kubectl rollout status deployment/${{ github.event.inputs.release_name }}-controller-manager -n ${{ github.event.inputs.namespace }} --timeout=5m

          echo "Checking CRD status..."
          kubectl wait --for condition=established --timeout=60s crd frappebenches.vyogo.tech
          kubectl wait --for condition=established --timeout=60s crd frappesites.vyogo.tech

          echo "Listing pods in ${{ github.event.inputs.namespace }}..."
          kubectl get pods -n ${{ github.event.inputs.namespace }}

          echo "✅ Frappe Operator successfully installed and verified!"

      - name: "Debug on Failure"
        if: failure()
        run: |
          echo "Installation failed. Capturing cluster state for debugging..."
          echo "--- Namespace: ${{ github.event.inputs.namespace }} ---"
          kubectl get pods -n ${{ github.event.inputs.namespace }}
          kubectl describe pods -n ${{ github.event.inputs.namespace }}
          echo "--- Operator Logs ---"
          kubectl logs -n ${{ github.event.inputs.namespace }} deployment/${{ github.event.inputs.release_name }}-controller-manager --tail=100 || true
          echo "--- MariaDB Operator Status ---"
          kubectl get pods -A | grep mariadb || true
          echo "--- KEDA Status ---"
          kubectl get pods -A | grep keda || true
