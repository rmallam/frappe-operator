name: Install Frappe Operator

on:
  workflow_dispatch:
    inputs:
      namespace:
        description: 'Namespace to install the operator into'
        required: true
        default: 'frappe-operator-system'
      create_namespace:
        description: 'Create the namespace if it does not exist'
        required: true
        type: boolean
        default: true
      release_name:
        description: 'Helm release name'
        required: true
        default: 'frappe-operator'
      image_tag:
        description: 'Operator image tag to install'
        required: true
        default: 'v0.0.6'
      image_repository:
        description: 'Operator image repository'
        required: true
        default: 'ghcr.io/rmallam/frappe-operator'

jobs:
  install:
    name: Install Operator via Helm
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'

      - name: Configure Kubectl
        uses: azure/k8s-set-context@v3
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBE_CONFIG }} # Requires KUBE_CONFIG secret

      - name: Add Helm Repositories
        run: |
          helm repo add mariadb-operator https://mariadb-operator.github.io/mariadb-operator
          helm repo add keda https://kedacore.github.io/charts
          helm repo update

      - name: "Install MariaDB Operator"
        run: |
          echo "Installing MariaDB Operator..."
          helm upgrade --install mariadb-operator mariadb-operator/mariadb-operator \
            --namespace ${{ github.event.inputs.namespace }} \
            ${{ github.event.inputs.create_namespace == 'true' && '--create-namespace' || '' }} \
            --set crds.enabled=true \
            --wait --timeout 10m

      - name: "Install KEDA (Autoscaler)"
        run: |
          echo "Installing KEDA..."
          helm upgrade --install keda keda/keda \
            --namespace ${{ github.event.inputs.namespace }} \
            ${{ github.event.inputs.create_namespace == 'true' && '--create-namespace' || '' }} \
            --set crds.install=true \
            --wait --timeout 10m

      - name: "Install Frappe Operator"
        run: |
          echo "Installing Frappe Operator..."
          # Dependencies are now explicitly disabled in Chart.yaml and values.yaml
          helm upgrade --install ${{ github.event.inputs.release_name }} ./helm/frappe-operator \
            --namespace ${{ github.event.inputs.namespace }} \
            ${{ github.event.inputs.create_namespace == 'true' && '--create-namespace' || '' }} \
            --set operator.image.repository=${{ github.event.inputs.image_repository }} \
            --set operator.image.tag=${{ github.event.inputs.image_tag }} \
            --set mariadb.enabled=true \
            --wait \
            --timeout 15m

      - name: Verify Installation
        run: |
          echo "Checking Frappe Operator status..."
          kubectl rollout status deployment/${{ github.event.inputs.release_name }}-controller-manager -n ${{ github.event.inputs.namespace }} --timeout=5m
          
          echo "Checking MariaDB Operator status..."
          kubectl rollout status deployment/mariadb-operator -n ${{ github.event.inputs.namespace }} --timeout=5m
          
          echo "Checking MariaDB instance status..."
          # Wait for the default MariaDB instance configured in values.yaml to be ready
          kubectl wait --for=condition=Ready mariadb/frappe-mariadb -n ${{ github.event.inputs.namespace }} --timeout=5m

          echo "Checking Frappe CRDs..."
          kubectl wait --for condition=established --timeout=60s crd frappebenches.vyogo.tech
          kubectl wait --for condition=established --timeout=60s crd frappesites.vyogo.tech

          echo "Listing pods in ${{ github.event.inputs.namespace }}..."
          kubectl get pods -n ${{ github.event.inputs.namespace }}

          echo "âœ… All components successfully installed and verified!"

      - name: "Debug on Failure"
        if: failure()
        run: |
          echo "Installation failed. Capturing cluster state for debugging..."
          echo "--- Namespace: ${{ github.event.inputs.namespace }} ---"
          kubectl get pods -n ${{ github.event.inputs.namespace }}
          kubectl describe pods -n ${{ github.event.inputs.namespace }}
          echo "--- Operator Logs ---"
          kubectl logs -n ${{ github.event.inputs.namespace }} deployment/${{ github.event.inputs.release_name }}-controller-manager --tail=100 || true
          echo "--- MariaDB Operator Status ---"
          kubectl get pods -A | grep mariadb || true
          echo "--- KEDA Status ---"
          kubectl get pods -A | grep keda || true
